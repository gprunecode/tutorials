%%
%% (
%%  )\ )                             (
%%  (()/(   (            (             )\  )   (
%%   /(_))  ))\   (       ))\  (   (   (()/(   ))\
%%   (_))  /((_)  )\  )  /((_) )\  )\   ((_))/((_)
%%   | _ \(_))(  _(_/( (_) )  ((_)((_)  _| |(_))
%%   |   /| || || ' \))/ -_)/ _|/ _ \/ _` |/ -_)
%%   |_|_\ \_,_||_||_| \___|\__|\___/\__,_|\___|
%%

\documentclass{article}
\usepackage{fontspec}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
%\usepackage{slashbox}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx} % Paquete para incluir imágenes en el documento LaTeX
\usepackage{hyperref}
\hypersetup{
  colorlinks=true,
  linkcolor=blue,
  filecolor=magenta,
  urlcolor=cyan,
}
\urlstyle{same}
\usepackage{varwidth}

\newcommand\tab[1][1cm]{\hspace*{#1}}

\usepackage{multirow}

\usepackage[a4paper,rmargin=1.5cm,lmargin=1.5cm,top=1.5cm,bottom=1.5cm]{geometry}

\usepackage{pdfpages}

\usepackage{xcolor}
\usepackage{minted}
\setminted[css]{frame=lines, framesep=2mm, baselinestretch=1.2, rulecolor=\color{black!80},
                bgcolor=DarkGray,fontsize=\normalsize}
\usemintedstyle[css]{monokai}
\setminted[python]{frame=lines, framesep=2mm, baselinestretch=1.2, rulecolor=\color{black!80}, bgcolor=DarkGray}
\usemintedstyle[python]{monokai}
\setminted[java]{frame=lines, framesep=2mm, baselinestretch=1.2, rulecolor=\color{black!80}, bgcolor=DarkGray}
\usemintedstyle[java]{monokai}
\setminted[javascript]{frame=lines, framesep=2mm, baselinestretch=1.2, rulecolor=\color{black!80}, bgcolor=DarkGray}
\usemintedstyle[javascript]{monokai}
\setminted[php]{frame=lines, framesep=2mm, baselinestretch=1.2, rulecolor=\color{black!30}, bgcolor=LightGray}
\setminted[html]{frame=lines, framesep=2mm, baselinestretch=1.2, rulecolor=\color{black!30}, bgcolor=LightGray}
\setminted[bash]{baselinestretch=1.2,rulecolor=\color{black!30},bgcolor=LightGray}
\definecolor{LightGray}{gray}{0.98}
\definecolor{DarkGray}{gray}{0.1}
\definecolor{MidGray}{gray}{0.8}
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}
\setminted[json]{frame=lines, framesep=2mm, baselinestretch=1.2, rulecolor=\color{black!80}, bgcolor=DarkGray}
\usemintedstyle[json]{monokai}
\setminted[apacheconf]{frame=lines, framesep=2mm, baselinestretch=1.2, rulecolor=\color{black!30}, bgcolor=LightGray}
\setminted[html+twig]{frame=lines, framesep=2mm, baselinestretch=1.2, rulecolor=\color{black!30}, bgcolor=LightGray}
\setminted[html+php]{frame=lines, framesep=2mm, baselinestretch=1.2, rulecolor=\color{black!30}, bgcolor=LightGray}

%\setlength{\parindent}{0px}  % Setea la indentacion de la primera linea de cada parrafo a cero pixeles.


\title{Programación en Laravel}
\author{@RuneCode}

\begin{document}

%% Clase 1
\section{Intro y características}%
Laravel es un framework completo que cuenta con muchos módulos que te ayudarán
para el desarrollo de tus aplicaciones. Existen otros frameworks de PHP como
Symfony o Zend, sin embargo Laravel es uno de los líderes en el mercado.\\

Laravel no solo es sencillo y tiene muchas herramientas de desarrollo, sino que
también cuenta con una amplia comunidad a su alrededor; esta comunidad ha
logrado que sea posible tener una excelente documentación que puede ser
encontrada en Laracast y se ha creado un gran ecosistema con foros y
comunidades.\\
También existen proyectos que se han desarrollado a partir de Laravel como
Lumen que es un micro-framework o Spark que te da un punto de inicio para
aplicaciones de cobros.\\

En este curso se trabajará pensando que ya tienes bases de PHP. Si no tienes
estas bases, puedes adquirirlas en el curso de Platzi de Introducción a PHP.\\
El proyecto del curso será crear un sistema para reporte de gastos.\\

%% Clase 2
\section{Instalación de Laravel}%
Composer es un manejador de dependencias para PHP, así que todas las
dependencias que necesitemos, incluído Laravel, serán instaladas por
Composer.
Para trabajar en Laravel necesitarás un servidor de PHP y una base de datos.\\
Laravel nos ofrece un instalador que podemos traer a través de Composer y
utilizaremos global en el comando para que la instalación se realice en toda la
máquina virtual o computador.
Podemos comprobar si Laravel quedó bien instalado usando el comando "laravel"
el cual nos dará la versión del instalador y los comandos disponibles.
El comando "new" nos ayuda a crear un nuevo proyecto de Laravel; al hacer esto
se crearán las carpetas y estructura del proyecto y el archivo composer con las
dependencias necesarias.
Para trabajar con Laravel es necesario tener la versión de PHP 7.1 o
superior.
El comando "artisan" nos da una serie de comandos de Laravel, son muchos y no
todos se utilizan pero es buena idea revisar la documentación y opciones
disponibles.
El comando "serve" levanta un servidor de PHP corriendo el proyecto actual, el
cual nos arroja una dirección IP la cual abriéndola nos muestra nuestro
proyecto.\\


\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.75]{./Pictures/001_Install_laravel.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.65]{./Pictures/002_estructura.png}
\end{figure}

\newpage

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/003_laravel.png}
\end{figure}


%% Clase 3
\section{Primera ruta en Laravel}%
Laravel cuenta con un mecanismo para generar rutas y especificar el método que
queremos utilizar (get, post, put…) teniendo la posibilidad de incluso
mezclarlos.\\

\begin{itemize}
  \item En el archivo web.php encontramos todas las rutas que trabajaremos.
  \item Las vistas se encuentran dentro de resources/views.
  \item Las vistas básicas se realizan utilizando closures.
  \item Podemos regresar vistas, textos, arreglos asociativos, entre otros;
    devolviendo los arreglos en formato json lo cual es muy útil al momento de
    realizar pruebas.
  \item Es en web.php donde podemos definir el método que vamos a usar.
\end{itemize}


\textbf{routes/web.php}
\begin{minted}{php}
  <?php

  /*
  |--------------------------------------------------------------------------
  | Web Routes
  |--------------------------------------------------------------------------
  |
  | Here is where you can register web routes for your application. These
  | routes are loaded by the RouteServiceProvider within a group which
  | contains the "web" middleware group. Now create something great!
  |
  */

  Route::get('/', function () {
      return view('welcome');
  });

  Route::get('/test', function () {
    return "Hola Platzi";
  });
\end{minted}


\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/004_test.png}
\end{figure}

\textbf{routes/web.php}
\begin{minted}{php}
  <?php

  /*
  |--------------------------------------------------------------------------
  | Web Routes
  |--------------------------------------------------------------------------
  |
  | Here is where you can register web routes for your application. These
  | routes are loaded by the RouteServiceProvider within a group which
  | contains the "web" middleware group. Now create something great!
  |
  */

  Route::get('/', function () {
      return view('welcome');
  });

  Route::get('/test', function () {
    return [
      'saludo' => 'Hola',
      'nombre' => 'Platzi'
    ];
  });
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/005_laravel_json.png}
\end{figure}

\textbf{resources/views/welcome.blade.php}
\begin{minted}{html+php}
  <!DOCTYPE html>
  <html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
      <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">

          <title>Laravel</title>

          <!-- Fonts -->
          <link href="https://fonts.googleapis.com/css?family=Nunito:200,600" rel="stylesheet">

          <!-- Styles -->
          <style>
              html, body {
                  background-color: #fff;
                  color: #636b6f;
                  font-family: 'Nunito', sans-serif;
                  font-weight: 200;
                  height: 100vh;
                  margin: 0;
              }

              .full-height {
                  height: 100vh;
              }

              .flex-center {
                  align-items: center;
                  display: flex;
                  justify-content: center;
              }

              .position-ref {
                  position: relative;
              }

              .top-right {
                  position: absolute;
                  right: 10px;
                  top: 18px;
              }

              .content {
                  text-align: center;
              }

              .title {
                  font-size: 84px;
              }

              .links > a {
                  color: #636b6f;
                  padding: 0 25px;
                  font-size: 13px;
                  font-weight: 600;
                  letter-spacing: .1rem;
                  text-decoration: none;
                  text-transform: uppercase;
              }

              .m-b-md {
                  margin-bottom: 30px;
              }
          </style>
      </head>
      <body>
          <div class="flex-center position-ref full-height">
              @if (Route::has('login'))
                  <div class="top-right links">
                      @auth
                          <a href="{{ url('/home') }}">Home</a>
                      @else
                          <a href="{{ route('login') }}">Login</a>

                          @if (Route::has('register'))
                              <a href="{{ route('register') }}">Register</a>
                          @endif
                      @endauth
                  </div>
              @endif

              <div class="content">
                  <div class="title m-b-md">
                      Curso Laravel
                  </div>

                  <div class="links">
                      <a href="https://laravel.com/docs">Docs</a>
                      <a href="https://laracasts.com">Laracasts</a>
                      <a href="https://laravel-news.com">News</a>
                      <a href="https://blog.laravel.com">Blog</a>
                      <a href="https://nova.laravel.com">Nova</a>
                      <a href="https://forge.laravel.com">Forge</a>
                      <a href="https://vapor.laravel.com">Vapor</a>
                      <a href="https://github.com/laravel/laravel">GitHub</a>
                  </div>
              </div>
          </div>
      </body>
  </html>
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/006_vistas.png}
\end{figure}

\textbf{routes/web.php}
\begin{minted}{php}
  <?php

  /*
  |--------------------------------------------------------------------------
  | Web Routes
  |--------------------------------------------------------------------------
  |
  | Here is where you can register web routes for your application. These
  | routes are loaded by the RouteServiceProvider within a group which
  | contains the "web" middleware group. Now create something great!
  |
  */

  Route::get('/', function () {
      return view('welcome');
  });

  Route::get('/test', function () {
    return view('test');
  });
\end{minted}

\textbf{resources/views/test.blade.php}
\begin{minted}{php}
  <!DOCTYPE html>
  <html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
      <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">

          <title>Laravel</title>

          <!-- Fonts -->
          <link href="https://fonts.googleapis.com/css?family=Nunito:200,600" rel="stylesheet">

          <!-- Styles -->
          <style>
              html, body {
                  background-color: #fff;
                  color: #636b6f;
                  font-family: 'Nunito', sans-serif;
                  font-weight: 200;
                  height: 100vh;
                  margin: 0;
              }

              .full-height {
                  height: 100vh;
              }

              .flex-center {
                  align-items: center;
                  display: flex;
                  justify-content: center;
              }

              .position-ref {
                  position: relative;
              }

              .top-right {
                  position: absolute;
                  right: 10px;
                  top: 18px;
              }

              .content {
                  text-align: center;
              }

              .title {
                  font-size: 84px;
              }

              .links > a {
                  color: #636b6f;
                  padding: 0 25px;
                  font-size: 13px;
                  font-weight: 600;
                  letter-spacing: .1rem;
                  text-decoration: none;
                  text-transform: uppercase;
              }

              .m-b-md {
                  margin-bottom: 30px;
              }
          </style>
      </head>
      <body>
          <div class="flex-center position-ref full-height">
              @if (Route::has('login'))
                  <div class="top-right links">
                      @auth
                          <a href="{{ url('/home') }}">Home</a>
                      @else
                          <a href="{{ route('login') }}">Login</a>

                          @if (Route::has('register'))
                              <a href="{{ route('register') }}">Register</a>
                          @endif
                      @endauth
                  </div>
              @endif

              <div class="content">
                  <div class="title m-b-md">
                      Curso Laravel en Platzi
                  </div>

                  <div class="links">
                      <a href="https://laravel.com/docs">Docs</a>
                      <a href="https://laracasts.com">Laracasts</a>
                      <a href="https://laravel-news.com">News</a>
                      <a href="https://blog.laravel.com">Blog</a>
                      <a href="https://nova.laravel.com">Nova</a>
                      <a href="https://forge.laravel.com">Forge</a>
                      <a href="https://vapor.laravel.com">Vapor</a>
                      <a href="https://github.com/laravel/laravel">GitHub</a>
                  </div>
              </div>
          </div>
      </body>
  </html>
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/007_test_vistas.png}
\end{figure}


%% Clase 4
\section{Cómo funciona Blade}%
Internamente Laravel utiliza un motor de render llamado Blade y utilizamos este
tipo motores porque PHP ha ido evolucionando más su parte de programación pero
no tanto su parte de motores de templates. Algunas librerías han sido creadas
para solventar esa falencia.\\

\begin{itemize}
  \item En nuestras vistas podremos encontrar estructuras de control como @if o
    @auth que son helpers de Blade.
  \item Cuando queremos enviar información desde nuestras rutas a nuestras
    vistas podemos hacerlo mediante arreglos asociativos en el archivo web.php,
    los cuales pueden ser mostrados como variables en las vistas.
  \item No es recomendado usar PHP dentro de Blade ya que para esto contamos
    con los helpers.
\end{itemize}

\textbf{resources/views/test.blade.php}
\begin{minted}{html+php}
  <!DOCTYPE html>
  <html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
      <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">

          <title>Laravel</title>

          <!-- Fonts -->
          <link href="https://fonts.googleapis.com/css?family=Nunito:200,600" rel="stylesheet">

          <!-- Styles -->
          <style>
              html, body {
                  background-color: #fff;
                  color: #636b6f;
                  font-family: 'Nunito', sans-serif;
                  font-weight: 200;
                  height: 100vh;
                  margin: 0;
              }

              .full-height {
                  height: 100vh;
              }

              .flex-center {
                  align-items: center;
                  display: flex;
                  justify-content: center;
              }

              .position-ref {
                  position: relative;
              }

              .top-right {
                  position: absolute;
                  right: 10px;
                  top: 18px;
              }

              .content {
                  text-align: center;
              }

              .title {
                  font-size: 84px;
              }

              .links > a {
                  color: #636b6f;
                  padding: 0 25px;
                  font-size: 13px;
                  font-weight: 600;
                  letter-spacing: .1rem;
                  text-decoration: none;
                  text-transform: uppercase;
              }

              .m-b-md {
                  margin-bottom: 30px;
              }
          </style>
      </head>
      <body>
          <div class="flex-center position-ref full-height">
              @if (Route::has('login'))
                  <div class="top-right links">
                      @auth
                          <a href="{{ url('/home') }}">Home</a>
                      @else
                          <a href="{{ route('login') }}">Login</a>

                          @if (Route::has('register'))
                              <a href="{{ route('register') }}">Register</a>
                          @endif
                      @endauth
                  </div>
              @endif

              <div class="content">
                  <div class="title m-b-md">
                      @isset($title)
                          {{ $title }}
                      @else
                          {{ 'No title' }}
                      @endisset
                  </div>

                  <div class="links">
                      <a href="https://laravel.com/docs">Docs</a>
                      <a href="https://laracasts.com">Laracasts</a>
                      <a href="https://laravel-news.com">News</a>
                      <a href="https://blog.laravel.com">Blog</a>
                      <a href="https://nova.laravel.com">Nova</a>
                      <a href="https://forge.laravel.com">Forge</a>
                      <a href="https://vapor.laravel.com">Vapor</a>
                      <a href="https://github.com/laravel/laravel">GitHub</a>
                  </div>
              </div>
          </div>
      </body>
  </html>
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/008_blade.png}
\end{figure}

\textbf{routes/web.php}
\begin{minted}{php}
  <?php

  /*
  |--------------------------------------------------------------------------
  | Web Routes
  |--------------------------------------------------------------------------
  |
  | Here is where you can register web routes for your application. These
  | routes are loaded by the RouteServiceProvider within a group which
  | contains the "web" middleware group. Now create something great!
  |
  */

  Route::get('/', function () {
      return view('welcome');
  });

  Route::get('/test', function () {
      return view('test', [
          'title' => 'Curso Laravel en Platzi!!!'
      ]);
  });
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/009_blade.png}
\end{figure}

%% Clase 5
\section{Controladores en Laravel}%
Basados en el modelo MVC, vimos que las vistas las tenemos en resources/views,
igualmente en la carpeta app/Http/Controllers podremos definir nuestros
controladores.\\
Aunque podemos utilizar closures directamente dentro de las rutas, Laravel
viene preparado para que trabajemos con controladores.\\

\begin{itemize}
  \item Cuando utilizamos el comando "artisan", encontramos una sección llamada
    "make" que nos va a permitir crear diferentes cosas en el proyecto.
    make:controller nos crea un nuevo controlador.
  \item En nuestro archivo web.php, en la parte de los parámetros, en vez de
    poner un closure vamos a poner el nombre del controlador que creamos
    seguido de una @ y finalizando el método que llamaremos de ese controlador.
\end{itemize}

\begin{minted}{bash}
  php artisan make:controller --help
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/010_artisan_make_controller.png}
\end{figure}

\begin{minted}{bash}
  php artisan make:controller HomeController
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/011_artisar_make_controller.png}
\end{figure}

Luego vamos a modificar el HomeController que se ha creado dentro de nuestra
ruta  \textbf{Http/Controllers/HomeController.php}\\

\textbf{Http/Controllers/HomeController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use Illuminate\Http\Request;

  class HomeController extends Controller {
      public function index() {
          return view('welcome');
      }
  }
\end{minted}

También modificamos:

\textbf{routes/web.php}
\begin{minted}{php}
  <?php

  /*
  |--------------------------------------------------------------------------
  | Web Routes
  |--------------------------------------------------------------------------
  |
  | Here is where you can register web routes for your application. These
  | routes are loaded by the RouteServiceProvider within a group which
  | contains the "web" middleware group. Now create something great!
  |
  */

  Route::get('/', 'HomeController@index');

  Route::get('/test', function () {
      return view('test', [
          'title' => 'Curso Laravel en Platzi!!!'
      ]);
  });
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/012_homeController.png}
\end{figure}

Ahora crearemos un controller \textbf{DashboardController} ya organizando
nuestro código para el proyecto.\\

\begin{minted}{bash}
  php artisan make:controller DashboardController
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/014_dashboardController.png}
\end{figure}

\textbf{app/Http/Controllers/DashboardController.php}
\begin{minted}{java}
  <?php

  namespace App\Http\Controllers;

  use Illuminate\Http\Request;

  class DashboardController extends Controller
  {
      public function index() {
          return view('test', [
              'title' => 'Curso Laravel en Platzi!!!'
          ]);
      }
  }
\end{minted}


\textbf{routes/web.php}
\begin{minted}{java}
  <?php

  /*
  |--------------------------------------------------------------------------
  | Web Routes
  |--------------------------------------------------------------------------
  |
  | Here is where you can register web routes for your application. These
  | routes are loaded by the RouteServiceProvider within a group which
  | contains the "web" middleware group. Now create something great!
  |
  */

  Route::get('/', 'HomeController@index');
  Route::get('/dashboard', 'DashboardController@index');
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/013_dashboardController.png}
\end{figure}



%% Clase 6
\textbf{Request}
El Request es el que contendrá la información que llega cuando alguien hace una
petición al servidor. Se podrán traer parámetros get, datos de formulario en
post o datos en la URL.\\

\begin{itemize}
  \item Laravel utiliza inyección de dependencias y cuando detecta que se
    recibe una variable request, sabe que debe inyectar el request que está
    accediendo a la acción.
  \item Contamos con un helper muy útil de Laravel que reemplaza el var\_dump y
    el die; este helper es dd.
\end{itemize}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/015_request.png}
\end{figure}

\textbf{app/Http/Controllers/DashboardController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use Illuminate\Http\Request;

  class DashboardController extends Controller
  {
      public function index(Request $request) {
          var_dump($request); die;
          return view('test', [
              'title' => 'Curso Laravel en Platzi!!!'
          ]);
      }
  }
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/016_vardump_request.png}
\end{figure}

\textbf{app/Http/Controllers/DashboardController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use Illuminate\Http\Request;

  class DashboardController extends Controller
  {
      public function index(Request $request) {
          dd($request->query('title'));
          return view('test', [
              'title' => 'Curso Laravel en Platzi!!!'
          ]);
      }
  }
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/017_dd_title.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/018_dd_title_null.png}
\end{figure}

\textbf{app/Http/Controllers/DashboardController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use Illuminate\Http\Request;

  class DashboardController extends Controller
  {
      public function index(Request $request) {
          dd($request->query('title', 'Valor default'));
          return view('test', [
              'title' => 'Curso Laravel en Platzi!!!'
          ]);
      }
  }
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/019_dd_title_default.png}
\end{figure}

\textbf{app/Http/Controllers/DashboardController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use Illuminate\Http\Request;

  class DashboardController extends Controller
  {
      public function index(Request $request) {
          return view('test', [
              'title' => $request->query('title', 'Valor default')
          ]);
      }
  }
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/020_title_default.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/021_title_hola_request.png}
\end{figure}



%% Clase 7
\section{Configuración de laravel}%
En nuestro archivo .env encontraremos mucha información sobre cómo se está
configurando Laravel como el nombre, el entorno de desarrollo, si muestra o no
debug, la URL de nuestra app, datos de conexión a nuestra base de datos, entre
otras opciones.\\

\textbf{APP\_NAME} indica el nombre de la aplicación, \textbf{APP\_ENV} recibe
"local" cuando se está en desarrollo y \textbf{production} es cuando ya lo
liberamos, en \textbf{APP\_DEBUG} especificamos si nuestra aplicación muestra
los errores o no los muestra, en \textbf{DB\_CONNECTION} indica la base de datos
en la que estás trabajando (recuerda que Laravel trabaja con un ORM llamado
Eloquent), \textbf{DB\_HOST} almacena la dirección del host, \textbf{DB\_PORT} el
puerto, \textbf{DB\_DATABASE} el nombre de la base de datos,
\textbf{DB\_USERNAME} el nombre de usuario, \textbf{DB\_PASSWORD} la
contraseña.\\

Para este ejemplo vamos a utilizar como nombre de nuestra base de datos
\textbf{cursolaravel} y en  \textbf{DB\_HOST} ya que estamos trabajando en
devilbox entonces indicaremos el virtualhost creado, en nuestro caso se llama
\textbf{my\_laravel.loc}\\

Veamos el contenido de \textbf{.env} con los cambios realizados:

\textbf{.env}
\begin{minted}{php}
  APP_NAME=Laravel
  APP_ENV=local
  APP_KEY=base64:CuYUhd6VUrFS1OrNbVb4TzqjGEQqkCcMIUQfjJKK0dI=
  APP_DEBUG=true
  APP_URL=http://localhost

  LOG_CHANNEL=stack

  DB_CONNECTION=mysql
  DB_HOST=my_laravel.loc
  DB_PORT=3306
  DB_DATABASE=cursolaravel
  DB_USERNAME=root
  DB_PASSWORD=

  BROADCAST_DRIVER=log
  CACHE_DRIVER=file
  QUEUE_CONNECTION=sync
  SESSION_DRIVER=file
  SESSION_LIFETIME=120

  REDIS_HOST=127.0.0.1
  REDIS_PASSWORD=null
  REDIS_PORT=6379

  MAIL_DRIVER=smtp
  MAIL_HOST=smtp.mailtrap.io
  MAIL_PORT=2525
  MAIL_USERNAME=null
  MAIL_PASSWORD=null
  MAIL_ENCRYPTION=null

  AWS_ACCESS_KEY_ID=
  AWS_SECRET_ACCESS_KEY=
  AWS_DEFAULT_REGION=us-east-1
  AWS_BUCKET=

  PUSHER_APP_ID=
  PUSHER_APP_KEY=
  PUSHER_APP_SECRET=
  PUSHER_APP_CLUSTER=mt1

  MIX_PUSHER_APP_KEY="${PUSHER_APP_KEY}"
  MIX_PUSHER_APP_CLUSTER="${PUSHER_APP_CLUSTER}"
\end{minted}


Toda la configuración que hacemos realmente se está llamando dentro de los
archivos que están en la carpeta config\\

Ahora vamos a crear una nueva base de datos:

\begin{itemize}
  \item Si vienes del curso de introducción a PHP, seguramente tienes
    PHPMyAdmin el cual puedes seguir usando o puedes cambiar a cualquier
    cliente que te guste.
\end{itemize}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/022_bd.png}
\end{figure}


%% Clase 8
\section{Cómo funcionan las Migraciones de DB}%
Laravel ofrece un sistema de migraciones de bases de datos las cuales pueden
ser vistas como una especie de control de código pero para bases de datos. Esto
es muy útil para equipos de trabajo al poder tener los cambios en el
repositorio y de esta manera cada miembro del equipo podrá ejecutar las
migraciones para tener los esquemas adecuados.\\

\begin{itemize}
  \item Tenemos un comando llamado make:migration que nos permite generar
    archivos de migraciones.
  \item Contamos con una sección entera llamada migrate que nos servirá para
    realizar diferentes acciones relacionadas con las migraciones. Si
    ejecutamos migrate sin nada más, ejecutará todas las migraciones pendientes
    en el equipo.
  \item migrate:fresh va a borrar todas las tablas y las creará de nuevo
    utilizando todas las migraciones que tenemos.
  \item migrate:rollback nos permite regresar un paso.
\end{itemize}

Puedes encontrar las migraciones en la carpeta database/migrations. Laravel nos
ofrece tres migraciones de inicio que son para crear tablas de usuarios, para
crear una tabla de resets de passwords y otra tabla para registrar trabajos
fallidos.\\

\begin{minted}{bash}
  php artisan migrate
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/023_migrate.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/024_migrate.png}
\end{figure}

Si vemos el contenido de la tabla migrations, encontraremos los ficheros que se
encontraban en database/migrations, si en caso nosotros añadimos algun fichero
entonces este no figurará en esta tabla hasta que hagamos la migración.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/025_table_migrations.png}
\end{figure}


Las migraciones tienen dos partes:

\begin{itemize}
  \item up, que nos dice qué va a crear la migración.
  \item down, que revierte lo que se hizo en la migración, activado al hacer
    rollback.
\end{itemize}

Al correr las migraciones se nos crearán 3 tablas, una de ella siendo
migrations que nos llevará el control de cómo se va generando cada cambio.\\

Laravel nos ofrece Schema que nos trae diferentes cosas para trabajar sobre los
sistemas de bases de datos.\\


%% Clase 9
\section{Migraciones en Artisan}%
Laravel es un framework de código abierto que agiliza el desarrollo de
aplicaciones web con PHP utilizando la arquitectura MVC y nos permite resolver
necesidades actuales como el manejo de eventos y la autenticación de usuarios.
Además, cuenta con un código modular y extensible por medio de un administrador
de paquetes y un soporte robusto para manejo de bases de datos.\\


\begin{minted}{bash}
  php artisan make:migration create_table_expense_reports --create=expense_reports
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/026_create_table_artisan.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/027_migration_file.png}
\end{figure}


\begin{minted}{bash}
  php artisan migrate
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/028_migrate.png}
\end{figure}

Luego vemos que se ha creado la tabla correctamente, con algunos campos
predeterminados.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/029_table_created.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/030_expense_reports.png}
\end{figure}

Como se observa ahora se ha agregado el nombre del fichero a la tabla
migrations.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/031_migrations_table.png}
\end{figure}

Nótece los números que se encuentran en el campo \textbf{batch}.\\
Estos números nos sirven de guía cuando hagamos \textbf{rollback}.

\begin{minted}{bash}
  php artisan migrate:rollback
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/032_rollback.png}
\end{figure}

Veamos la tabla \textbf{migrations} esta vez.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/033_migrations_table.png}
\end{figure}

Si hacemos nuevamente un \textbf{rollback}.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/034_rolback.png}
\end{figure}

Como observamos ahora, no hay ningun registro en nuestra tabla
\textbf{migrations}.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/035_migrations_table.png}
\end{figure}

Sin embargo los archivos de migración aún se encuentran en nuestro directorio
\textbf{database/migrations}.\\
Podemos usar el siguiente comando para reestableces nuestras tablas.\\

\begin{minted}{bash}
  php artisan migrate
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/036_migrate_again.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/037_migrations_table.png}
\end{figure}

Como se observa, ahora todos los registros en nuestra tabla \textbf{migrations}
tienen \textbf{batch} con valor 1.


%% Clase 10
\section{Modelos con Eloquent}%
Un ORM es un sistema que nos permite mapear registros de la base de datos a
objetos dentro dentro de nuestro código. No es exclusivo de PHP ya que se usa
mucho en los lenguajes de programación orientada a objetos.\\

\begin{itemize}
  \item make:model crea una nueva clase para representar un modelo de Eloquent.
  \item Cuando creamos las bases de datos es estándar que las tablas tengan el
    nombre en plural pero los modelos como representan una clase que representa
    un objeto, tendrán su nombre en singular.
  \item Todos los modelos los podremos encontrar dentro de la carpeta app.
    Laravel no tiene carpeta models porque los creadores creen que model puede
    tener muchos significados.
  \item El comando tinker nos ofrece un entorno de pruebas para ver cómo
    funcionan las cosas que estamos haciendo. Tiene en cuenta variables de
    entorno, lo que inicializa Laravel y también sabe que estamos usando
    Eloquent.
\end{itemize}

Siempre podemos visualizar información de ayuda para el uso de los comandos
agregando el flag --help.

\begin{minted}{bash}
  php artisan make:model --help
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/038_make_model_help.png}
\end{figure}

Ahora vamos a crear un Modelo.

\begin{minted}{bash}
  php artisan make:model ExpenseReport
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/039_model_created.png}
\end{figure}

Con Laravel no hay una carpeta \textbf{Model} o \textbf{Entity}, sino que todos
los modelos se almacenan dentro de la carpeta \textbf{app/}.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/039_model_created_tree.png}
\end{figure}

Hay una herramienta que nos permite interactuar con nuestro código, como una
expecie de entorno de pruebas o sandbox y carga todos los componentes
inicializados que estan incluidos en Laravel, en este caso usaremos Eloquent y
vamos a jugar un poco.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/040_artisan_tinker.png}
\end{figure}

Como se ve con la primera instrucción le consultamos cuantos ExpertReports
tenemos actualmente y nos devolvió una colección de Eloquent pero como un array
vacío. En la segunda instrucción creamos un nuevo reporte y nos devuelve que se
creó el reporte, pero es un objeto en memoria. Con la tercera instrucción
persistimos el reporte con el metodo \textbf{save}, esto nos devuelve un true
que indica que se realizó exitosamente. Con la cuarta instrucción volvemos a
consultar el contenido de la tabla con el modelo ExpenseReport y nos devuelve
una colección de eloquent con la propiedad all con el primer ExpenseReport
creado con el id 1 y las fechas de created\_at y updated\_at. Esto lo podemos
visualizar también en nuestro cliente de Base de Datos.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/041_registro_expense_reports.png}
\end{figure}


%% Clase 11
\section{Trabajando con un Modelo}%
\begin{itemize}
  \item No es aconsejable modificar una migración ya que si estamos trabajando
    en equipo alguien puede haber ya corrido la migración con anterioridad y
    esto le causaría conflictos. Lo aconsejable es crear una migración
    adicional.
  \item El comando migrate:fresh lo reinicia todo incluyendo la base de datos y
    los elementos creados.
\end{itemize}

Para crear una migration entonces lo hacemos usando artisan indicando el nombre
de la tabla.
\begin{minted}{bash}
  php artisan make:migration create_column_title_in_reports --table=expense_reports
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/040_migration_file.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/042_php_migration.png}
\end{figure}

\textbf{database/migrations/2019\_11\_23\_190804\_create\_column\_title\_in\_reports.php}
\begin{minted}{php}
  <?php

  use Illuminate\Database\Migrations\Migration;
  use Illuminate\Database\Schema\Blueprint;
  use Illuminate\Support\Facades\Schema;

  class CreateColumnTitleInReports extends Migration
  {
      /**
      * Run the migrations.
      *
      * @return void
      */
      public function up()
      {
          Schema::table('expense_reports', function (Blueprint $table) {
              $table->text('title');
          });
      }

      /**
      * Reverse the migrations.
      *
      * @return void
      */
      public function down()
      {
          Schema::table('expense_reports', function (Blueprint $table) {
              $table->dropColumn('title');
          });
      }
  }
\end{minted}

Luego hacemos la migración:
\begin{minted}{bash}
  php artisan migrate
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/041_migrate.png}
\end{figure}

Luego revisamos la tabla y verificamos que se ha creado el campo
\textbf{title} de tipo text.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/043_title.png}
\end{figure}

También revisemos el contenido de la tabla \textbf{migrations} y observamos que
se creó un nuevo registro con el nombre de nuestro fichero de migración y con
el campo \textbf{batch} en valor 2.\\

Por último con \textbf{fresh} podemos eliminar todo el contenido de nuestras
bases de datos y crear nuevamente las tablas.

\begin{minted}{bash}
  php artisan migrate:fresh
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/044_migrate_fresh.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/045_migration_fresh.png}
\end{figure}

Como vemos la tabla \textbf{migrations} ahora tiene todos los registros con el
\textbf{batch} en valor 1. Además el registro que teníamos en la tabla
\textbf{expense\_reports} también ha desaparecido.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/046_expense_report_dropped.png}
\end{figure}

Entonces vamos usar \textbf{tinker} para crear un registro en la tabla.

\begin{minted}{bash}
  php artisan tinker
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/047_new_reg_tinker.png}
\end{figure}

También podemos visualizar el registro en nuestro cliente de Base de Datos.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/048_expense_report.png}
\end{figure}


%% Clase 12
\section{Controladores y recursos}%
CRUD significa create (crear), read (leer), update (actualizar o editar),
delete (eliminar).\\

\textbf{resource} genera una clase de controlador de tipo recurso. Esto
significa que tendremos todo lo necesario para poder hacer CRUD.\\

\begin{itemize}
  \item index: Aquí se despliegan todos los elementos a mostrar.
  \item create: Creará nuevos elementos.
  \item store: Guardará los elementos creados en create.
  \item show: Mostrará a detalle un solo elemento y por eso es que recibe un id.
  \item edit: Edita los elementos que mostramos en show.
  \item update: Almacena los cambios de edit en la base de datos.
  \item destroy: Eliminará los elementos.
\end{itemize}

Creamos nuestro controller con el flag \textbf{--resource}. Esto nos creará los
métodos en blanco para poder realizar CRUD con nuestro controller.\\

\begin{minted}{bash}
  php artisan make:controller ExpenseReportController --resource
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/049_controller_resource.png}
\end{figure}

En route:list podremos ver todas las rutas que tenemos definidas\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/050_route_list.png}
\end{figure}

Para crear una ruta de un controlador resource no usamos get o post, sino
directamente la estructura Route::resource(); ya que de esta manera se nos
crearán rutas para cada uno de los métodos anteriormente mencionados que son
creados por el controlador resource.

\textbf{routes/web.php}
\begin{minted}{php}
  <?php

  /*
  |--------------------------------------------------------------------------
  | Web Routes
  |--------------------------------------------------------------------------
  |
  | Here is where you can register web routes for your application. These
  | routes are loaded by the RouteServiceProvider within a group which
  | contains the "web" middleware group. Now create something great!
  |
  */

  Route::get('/', 'HomeController@index');
  Route::get('/dashboard', 'DashboardController@index');
  Route::resource('/expense_reports', 'ExpenseReportController');
\end{minted}

Con solo hacer esto, veamos nuevamente la lista de nuestras rutas.

\begin{minted}{bash}
  php artisan route:list
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/051_rout_list_after.png}
\end{figure}

Ahora vamos a modificar el método index dentro de ExpenseReportController para
mostrar todos los registros que tenga.

\textbf{app/Http/Controllers/}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return ExpenseReport::all();
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          //
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          //
      }

      /**
      * Display the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function show($id)
      {
          //
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          //
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          //
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          //
      }
  }
\end{minted}

Luego vamos a nuestro navegador y escribimos en el url /expense\_reports\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/052_expense_reports.png}
\end{figure}

Ahora vamos a añadirle una vista. Para esto vamos a copiar el contenido de la
vista \textbf{welcome.blade.php} en una nueva carpeta llamada
\textbf{expenseReport}, con la finalidad de ir organizando nuestras vistas en
el fichero llamado \textbf{index.blade.php}.\\

Luego vamos a modificar el contenido de la siguiente manera:

\textbf{resources/views/expenseReport/index.blade.php}
\begin{minted}{html+php}
  <!DOCTYPE html>
  <html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
      <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">

          <title>Laravel</title>

          <!-- Fonts -->
          <link href="https://fonts.googleapis.com/css?family=Nunito:200,600" rel="stylesheet">

          <!-- Styles -->
          <style>
              html, body {
                  background-color: #fff;
                  color: #636b6f;
                  font-family: 'Nunito', sans-serif;
                  font-weight: 200;
                  height: 100vh;
                  margin: 0;
              }

              .full-height {
                  height: 100vh;
              }

              .flex-center {
                  align-items: center;
                  display: flex;
                  justify-content: center;
              }

              .position-ref {
                  position: relative;
              }

              .top-right {
                  position: absolute;
                  right: 10px;
                  top: 18px;
              }

              .content {
                  text-align: center;
              }

              .title {
                  font-size: 84px;
              }

              .links > a {
                  color: #636b6f;
                  padding: 0 25px;
                  font-size: 13px;
                  font-weight: 600;
                  letter-spacing: .1rem;
                  text-decoration: none;
                  text-transform: uppercase;
              }

              .m-b-md {
                  margin-bottom: 30px;
              }
          </style>
      </head>
      <body>
          <div class="flex-center position-ref full-height">
              @if (Route::has('login'))
                  <div class="top-right links">
                      @auth
                          <a href="{{ url('/home') }}">Home</a>
                      @else
                          <a href="{{ route('login') }}">Login</a>

                          @if (Route::has('register'))
                              <a href="{{ route('register') }}">Register</a>
                          @endif
                      @endauth
                  </div>
              @endif

              <div class="content">
                  <div class="row">
                      <div class="col">
                          <h1>Reports</h1>
                          <table class="table">
                              @foreach ($expenseReports as $expenseReport)
                                  <tr>
                                      <td>{{ $expenseReport->title }}</td>
                                  </tr>
                              @endforeach
                          </table>
                      </div>
                  </div>
              </div>
          </div>
      </body>
  </html>
\end{minted}

Actualizamos en nuestro navegador y obtenemos:\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/053_expense_reports_ok.png}
\end{figure}



%% Clase 13
\section{Blade layout}%
Cuando se tienen muchas vistas que repiten gran parte del código HTML, una
mejor práctica para evitar esta repetición es crear layouts y extender de
ellos. De esta manera el layout tendrá el contenido que siempre se repite y los
hijos el código específico de ellos.\\

\begin{itemize}
  \item @yield marca la parte en donde irá el código de los hijos que extiendan
    o hereden del layout.
  \item En las vistas hijas se utiliza @section para decir que esa parte del
    código es la que concuerda con el @yield del layout.
\end{itemize}

Veamos en el proyecto. Creamos una carpeta dentro de \textbf{resources/views}
llamada \textbf{layouts} donde agregaremos el starter template de bootstrap que
podemos encontrar al principio de su documentación en la siguiente
\href{https://getbootstrap.com/docs/4.3/getting-started/introduction/}{página}
en el archivo \textbf{base.blade.php}.\\

\textbf{resouces/views/layouts/base.blade.php}
\begin{minted}{html+php}
  <!doctype html>
  <html lang="en">
    <head>
      <!-- Required meta tags -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1,
                  shrink-to-fit=no">

      <!-- Bootstrap CSS -->
      <link rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
            integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
            crossorigin="anonymous">

      <title>Expense Reports</title>
    </head>
    <body>
      <div class="container">
        @yield('content')
      </div>

      <!-- Optional JavaScript -->
      <!-- jQuery first, then Popper.js, then Bootstrap JS -->
      <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
              integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
              crossorigin="anonymous"></script>
      <script
        src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
      <script
        src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    </body>
  </html>
\end{minted}

Luego modificamos el fichero \textbf{index.blade.php} ubicado en el directorio
\textbf{expenseReport}. Borramos todo lo que se repite en el layout y
extendemos de \textbf{layouts/base.blade.php}\\

\textbf{resources/views/expenseReport/index.blade.php}
\begin{minted}{php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>Reports</h1>
              <table class="table">
                  @foreach ($expenseReports as $expenseReport)
                      <tr>
                          <td>{{ $expenseReport->title }}</td>
                      </tr>
                  @endforeach
              </table>
          </div>
      </div>
  @endsection
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/054_extends_layout.png}
\end{figure}



%% Clase 14
\section{Form para agregar reportes}%

Vamos a crear una nueva vista para el formulario en la carpeta
\textbf{expenseReport} llamado \textbf{create.blade.php}:\\

\textbf{resources/views/expenseReport/create.blade.php}
\begin{minted}{php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>New Report</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-secondary" href="/expense_reports">Back</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
          </div>
      </div>
  @endsection
\end{minted}

También modificamos nuestra vista index.blade.php:\\

\textbf{resources/views/expenseReport/index.blade.php}
\begin{minted}{php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>Reports</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-primary" href="/expense_reports/create">Create a new report</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <table class="table">
                  @foreach ($expenseReports as $expenseReport)
                      <tr>
                          <td>{{ $expenseReport->title }}</td>
                      </tr>
                  @endforeach
              </table>
          </div>
      </div>
  @endsection
\end{minted}

Ahora modificamos la funcion create del controller
\textbf{ExpenseReportController} para que retorne la vista \textbf{create} que
acabamos de crear.\\

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          //
      }

      /**
      * Display the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function show($id)
      {
          //
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          //
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          //
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          //
      }
  }
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/055_btn_create.png}
\end{figure}

El boton \textbf{Create a new report} nos lleva a la vista create con url
\textbf{expense\_reports/create}.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/056_new_report_btn_back.png}
\end{figure}

El botón \textbf{back} nos regresa a la vista index con url
\textbf{/expense\_reports}.\\

Ahora vamos crear un nuevo tag form. En este caso la acción va a seguir siendo
\textbf{/expense\_reports} y el método que usaremos sera \textbf{post}.\\

Para comprender mejor esto podemos visualizar nuestra lista de rutas en la que
el método \textbf{store} para expense\_reports tiene como endpoint al mismo url
\textbf{expense\_reports} pero con el método \textbf{POST}.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/057_store_post.png}
\end{figure}

Entonces proseguimos con la creación del formulario:\\

\textbf{resources/views/expenseReport/create.blade.php}
\begin{minted}{php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>New Report</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-secondary" href="/expense_reports">Back</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <form action="/expense_reports" method="post">
                  <div class="form-group">
                      <label for="title">Title:</label>
                      <input type="text" class="form-control" name="title" id="title" placeholder="Type a title">
                  </div>
                  <button class="btn btn-primary" type="submit">Submit</button>
              </form>
          </div>
      </div>
  @endsection
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/058_formulario.png}
\end{figure}



%% Clase 15
\section{CSRF}%
Ahora que ya tenemos creado el formulario, vamos a intentar enviar datos a
través de él a nuestra base de datos con el botón Submint.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/059_enviando_form.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/060_error_419.png}
\end{figure}

Como se observa nos devuelve el error 419. Este error lo devuelve Laravel y
significa que tenemos un posible ataque de CSRF.\\

CSRF (Cross-site request forgery) es un tipo de ataque que consiste en que un
usuario puede intentar hacer muchas peticiones en nombre de otro. Para esto
Laravel genera con cada sesión un token que se usará para validar que exista el
usuario en el sistema y que sea él quien está haciendo la petición. Esto
también implica que no se pueden hacer peticiones desde otra app hacia el post,
debe manejarse de manera interna.\\

Si queremos que un form pueda pasar la seguridad CSRF de Laravel, debemos
agregar el helper @csrf el cual nos agrega un token.\\

\textbf{resources/views/expenseReport/create.blade.php}
\begin{minted}{php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>New Report</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-secondary" href="/expense_reports">Back</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <form action="/expense_reports" method="post">
                  @csrf
                  <div class="form-group">
                      <label for="title">Title:</label>
                      <input type="text" class="form-control" name="title" id="title" placeholder="Type a title">
                  </div>
                  <button class="btn btn-primary" type="submit">Submit</button>
              </form>
          </div>
      </div>
  @endsection
\end{minted}

Si actualizamos nuestra página y luego inspeccionamos el input del formulario
ahora ha aparecio un nuevo elemento que está oculto y que nos permitirá
saltarnos el error 401 que apareción anteriormente.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/061_token_hidden_scrf.png}
\end{figure}

Damos click en Submit.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/062_submit_again.png}
\end{figure}

Como se observa, nos devuelve una página en blanco, y aún no se ha almacenado
nada en nuestra base de datos.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/063_blank_page.png}
\end{figure}


Luego de esto ya estamos listos para trabajar en el método \textbf{store} que
maneja los datos que vienen en el objeto \textbf{\$request} que nos envía
Laravel.\\

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          $report = new ExpenseReport();
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Display the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function show($id)
      {
          //
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          //
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          //
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          //
      }
  }
\end{minted}

Dentro del método \textbf{store} se ha creado un objeto \textbf{ExpenseReport}
el cual recibe en su atributo \textbf{title} el valor del request en la llave
\textbf{'title'} (se obtiene usando el método \textbf{get} que ingresa el
argumento llave), que es como se nombró en la vista del formulario
resources/views/expenseReport/create.blade.php\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/066_name_title.png}
\end{figure}

Luego se usa el método \textbf{save} para persistir en la base de datos.

\begin{itemize}
  \item Cuando estamos guardando nuevas entradas en la base de datos podemos
    redireccionar adonde queramos en nuestra aplicación con una respuesta
    especial de Laravel llamada redirect.
\end{itemize}

Finalmente se retorna al url \textbf{expense\_reports} usando el método de
Láravel llamado \textbf{redirect}.\\

Enviamos un valor en el formulario dando clic en Submit.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/064_submit_cena.png}
\end{figure}

Como se observa esta vez nos redireciona a la lista de reportes y podemos
visualizar nuestro último registro agregado junto al anterior.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/065_store_ok.png}
\end{figure}

También verificamos en PHPMyAdmin donde se visualizan dos registros entre ellos
el último enviado.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/067_bd_ok.png}
\end{figure}

Estamos trabajando con \textbf{Middlewares} los cuales son muy usados en
aplicaciones web que consisten en capas que contienen el request. Cuando llega
un request, éste deberá pasar por diferentes capas o filtros (middlewares)
quienes al final regresarán una respuesta. Cada uno de los filtros puede
detener las peticiones en caso de que algo no cumpla. Por ejemplo si no cumple
con el filtro de CSRF entonces retorna el error 419.\\

Si no se desea usar la protección CSRF se puede directamente quitar el
middleware desde el archivo \textbf{app/Http/kernel.php}. De la misma manera se
pueden crear middleware propios y agregarlos aquí.\\

En este archivo encontramos en \textbf{\$middleware} varios middlewares que se
han creado por ejemplo para verificar el modo mantenimiento que si nosotros
habilitamos entonces todas las peticiones que se hagan recibirán como respuesta
el modo mantenimiento "La aplicación está en modo mantenimiento".

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/069_middlewareMaintenanceMode.png}
\end{figure}

En la parte de \textbf{\$middlewareGroups} econtramos dos secciones
\textbf{'web'} (la que nosotros estamos usando) y \textbf{'api'} (relacionada
con el archivo de rutas api.php). Y como podemos observar dentro del grupo web
tenemos la clase que se llama \textbf{VeriyfyCsrfToken} que indica que todas
las peticiones que apliquen y que necesiten utilizar el csrf tocken van a pasar
por ese middleware. Si ustedes no quieren usar la protección csrf, pues una
solución podría ser que quitemos esa línea de código del fichero. También hay
la posibilidad que ustedes creen sus propios middlewares y los podrían agregar
dentro de los grupos en esta misma sección.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/068_middlewareGroups.png}
\end{figure}


%% Clase 16
\section{Fake PUT/PATCH}%
Ahora que ya podemos crear reportes, vamos a \textbf{editarlos}. Normalmente
cuando estamos trabajando en edición, enviamos también métodos post hacia un
endpoint especial y en ese endpoint guardamos cualquier cambio que se quiera
hacer al objeto. Pero en Laravel cuando estamos utilizando \textbf{recursos}
ellos nos proponen que utilicemos el Put y el Path como una opción para
modificar nuestros recursos.\\

En Laravel cuando usamos recursos nos pone Put y Patch como una opción para
modificar nuestros recursos. El problema de esto es que en un form no se puede
especificar directamente que queremos hacer un Put o un Patch y por esto
Laravel nos ofrece un mecanismo para hacer ”Fake PUT/PATCH” y podamos recibir y
procesar los datos.\\

Para que Laravel acepte el Put o Patch es necesario poner dentro del form de
manera auxiliar @method(‘tipo de método usado’) y así aunque el form tenga un
POST como método, realmente será traducido al que especifiquemos dentro del
auxiliar.\\

\textbf{resources/views/expenseReport/index.blade.php}
\begin{minted}{html+php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>Reports</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-primary" href="/expense_reports/create">Create a new report</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <table class="table">
                  @foreach ($expenseReports as $expenseReport)
                      <tr>
                          <td>{{ $expenseReport->title }}</td>
                          <td><a href="/expense_reports/{{$expenseReport->id}}/edit">Edit</a></td>
                      </tr>
                  @endforeach
              </table>
          </div>
      </div>
  @endsection
\end{minted}

Como se verifica se ha creado una nueva columna con el enlace \textbf{Edit} que
nos redireccionará un enlace en el que editaremos el registro.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/070_columna_edit.png}
\end{figure}

Se puede ver el url que incluye el id del registro que vamos a modificar.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/071_url_edit.png}
\end{figure}

Laravel nos indica que en el método \textbf{edit} será el encargado de mostrar
el formulario que editará el recurso especificado.\\

Vamos a crear una nueva vista, esta vez para \textbf{edit} basándonos en
\textbf{create}:

\textbf{resources/views/expenseReport/edit.blade.php}
\begin{minted}{html+php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>Edit Report {{ $report->id }}</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-secondary" href="/expense_reports">Back</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <form action="/expense_reports" method="post">
                  @csrf
                  @method('put')
                  <div class="form-group">
                      <label for="title">Title:</label>
                      <input type="text" class="form-control" name="title" id="title" placeholder="Type a title">
                  </div>
                  <button class="btn btn-primary" type="submit">Submit</button>
              </form>
          </div>
      </div>
  @endsection
\end{minted}

Así mismo en el método \textbf{edit} retornaremos la vista pasándole el objeto
\textbf{\$report}.

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          $report = new ExpenseReport();
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Display the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function show($id)
      {
          //
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          $report = ExpenseReport::find($id);
          return view('expenseReport.edit', [
              'report' => $report
          ]);
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          dd('put update');
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          //
      }
  }
\end{minted}

Ahora hacemos submit en el formulario para editar y con el método \textbf{dd}
verificaremos si se esta ingresando al método update.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/072_submit_test.png}
\end{figure}

Se verifica un error que menciona que la ruta indicada no soporta el método
PUT. Esto se debe a que el url \textbf{expense\_report} sin un id no acepta al
método PUT.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/073_error_put.png}
\end{figure}

Entonces vamos a modificar el url indicado en \textbf{action} del formulario.\\

\textbf{resources/views/expenseReport/edit.blade.php}
\begin{minted}{php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>Edit Report {{ $report->id }}</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-secondary" href="/expense_reports">Back</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <form action="/expense_reports/{{ $report->id }}" method="post">
                  @csrf
                  @method('put')
                  <div class="form-group">
                      <label for="title">Title:</label>
                      <input type="text" class="form-control" name="title" id="title" placeholder="Type a title">
                  </div>
                  <button class="btn btn-primary" type="submit">Submit</button>
              </form>
          </div>
      </div>
  @endsection
\end{minted}

Ahora recargamos nuestra página y volvemos a dar clic en editar y probamos
enviar cualquier contenido en el formulario con submit. Entonces obtendremos lo
siguiente:\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/073_error_put.png}
\end{figure}

Ahora que ya pudimos ingresar al método \textbf{update}, entonces vamos
modificar su comportamiento para poder persistir los cambios de la edición.\\

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          $report = new ExpenseReport();
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Display the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function show($id)
      {
          //
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          $report = ExpenseReport::find($id);
          return view('expenseReport.edit', [
              'report' => $report
          ]);
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          $report = ExpenseReport::find($id);
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          //
      }
  }
\end{minted}

Luego de hacer esto, provamos editar el títuto \textbf{Vacaciones} por
\textbf{Vacaiones de verano}.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/074_edit_vacaciones.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/075_vacaciones_verano.png}
\end{figure}

Como se visualiza, los cambios se han realizado exitosamente.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/076_update_ok.png}
\end{figure}




%% Clase 17
\section{Borrando reportes}%
De la misma forma en la que pudimos crear un “Fake PUT/PATCH” también podemos
crear una especie de “Fake DELETE”.\\

\begin{itemize}
  \item Con Javascript podemos mostrar una alerta al borrar una entrada que nos
    permita confirmar si la vamos a borrar o no.
  \item Es bueno que las vistas hagan match con la acción porque permite
    encontrar rápidamente qué vista le pertenece a qué acción.
  \item Laravel nos ofrece el helper @method(‘delete’) ya que no se puede
    especificar directamente en el form.
  \item Tenemos con Laravel un método especial findOrFail que permitirá
    regresar un error 404 si un usuario está haciendo algo no válido al
    consultar o editar un registro en la base de datos.
\end{itemize}

Primero vamos a crear una nueva columna para mostrar la nueva opción de borrar
el registro con una vista previa de confirmación.\\

\textbf{resources/views/expenseReport/index.blade.php}
\begin{minted}{php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>Reports</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-primary" href="/expense_reports/create">Create a new report</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <table class="table">
                  @foreach ($expenseReports as $expenseReport)
                      <tr>
                          <td>{{ $expenseReport->title }}</td>
                          <td><a href="/expense_reports/{{$expenseReport->id}}/edit">Edit</a></td>
                          <td><a href="/expense_reports/{{$expenseReport->id}}/confirmDelete">Delete</a></td>
                      </tr>
                  @endforeach
              </table>
          </div>
      </div>
  @endsection
\end{minted}

Como no tenemos mapeado la ruta \textbf{confirmDelete} ya que no existe
previamente tenemos que añadirla de manera manual en las rutas.

\textbf{routes/web.php}
\begin{minted}{php}
  <?php

  /*
  |--------------------------------------------------------------------------
  | Web Routes
  |--------------------------------------------------------------------------
  |
  | Here is where you can register web routes for your application. These
  | routes are loaded by the RouteServiceProvider within a group which
  | contains the "web" middleware group. Now create something great!
  |
  */

  Route::get('/', 'HomeController@index');
  Route::get('/dashboard', 'DashboardController@index');
  Route::resource('/expense_reports', 'ExpenseReportController');
  Route::get('/expense_reports/{id}/confirmDelete', 'ExpenseReportController@confirmDelete');
\end{minted}

Como se visualiza, en esta ocasión tendremos que indicar el controller con el
método al cual direccionará.\\

Ahora crearemos el método en el controller y con \textbf{dd} verificaremos si
accedemos.

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          $report = new ExpenseReport();
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Display the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function show($id)
      {
          //
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          $report = ExpenseReport::find($id);
          return view('expenseReport.edit', [
              'report' => $report
          ]);
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          $report = ExpenseReport::find($id);
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          //
      }

      public function confirmDelete($id) {
          dd('confirmDelete' . $id);
      }
  }
\end{minted}

Refrescamos el navegador y ahora veremos una nueva columna con un enlace
Delete.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/077_delete.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/078_confirm_delete1.png}
\end{figure}

Ahora vamos a crear una nueva vista, podemos copiar el contenido de la vista
\textbf{edit}. Como recomendación, puedes tratar de mantener el nombre de la
acción en las vistas para poder relacionarlos de manera más rápida.

\textbf{resources/views/expenseReport/confirmDelete.blade.php}
\begin{minted}{php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>Delete Report {{ $report->id }}</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-secondary" href="/expense_reports">Back</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <form action="/expense_reports/{{ $report->id }}" method="post">
                  @csrf
                  @method('delete')
                  <button class="btn btn-primary" type="submit">Delete</button>
              </form>
          </div>
      </div>
  @endsection
\end{minted}

Note como en formulario pasamos el helper \textbf{@method} para hacer un fake
delete.\\

También vamos a modificar el método \textbf{confirmDelete} para que retorne la
vista con el objeto \textbf{\$report} correspondiente.

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          $report = new ExpenseReport();
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Display the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function show($id)
      {
          //
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          $report = ExpenseReport::find($id);
          return view('expenseReport.edit', [
              'report' => $report
          ]);
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          $report = ExpenseReport::find($id);
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          //
      }

      public function confirmDelete($id) {
          $report = ExpenseReport::find($id);
          return view('expenseReport.confirmDelete', [
              'report' => $report
          ]);
      }
  }
\end{minted}

Una vez hecho esto, refrescamos nuestro navegador y si damos clic en Delete
para el primer registro entonces obtendremos la siguiente vista.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/079_confirm_delete1.png}
\end{figure}

Para finalizar vamos a difinir el método \textbf{destroy} para que se elimine
el registro y además nos redireccione al url \textbf{/expense\_reports}.\\

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          $report = new ExpenseReport();
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Display the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function show($id)
      {
          //
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          $report = ExpenseReport::find($id);
          return view('expenseReport.edit', [
              'report' => $report
          ]);
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          $report = ExpenseReport::find($id);
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          $report = ExpenseReport::find($id);
          $report->delete();

          return redirect('/expense_reports');
      }

      public function confirmDelete($id) {
          $report = ExpenseReport::find($id);
          return view('expenseReport.confirmDelete', [
              'report' => $report
          ]);
      }
  }
\end{minted}

Ahora vamos al navegador y damos en eliminar el primer registros que es
\textbf{Vacaciones}.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/080_eliminar_vacaciones.png}
\end{figure}

Confirmamos dando clic en el botón \textbf{Delete}.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/081_delete_confirm.png}
\end{figure}

Y como verificamos se redirecciona a la página que lista los reportes.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/082_delete_ok.png}
\end{figure}

Luego probamos eliminar el otro registro. Ahora podemos crear un nuevo registro
y editarlo. Tenemos el CRUD completo.\\

Por ejemplo del nuevo registro que hemos creado si damos clic en editar, nos
fijamos en el url el número del id aparece. Si el usuario intenta cambiarlo por
cualquier otro número entonces nuestra aplicación retornará un error.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/083_edit_url_id.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/084_edit_url_id_error.png}
\end{figure}

Para evitar esto y que nuestra aplicación sea más segura, entonces podemos
validar la existencia del objeto \$report. Podríamos hacerlo con un if y luego
lanzar una excepción, pero Laravel nos proporciona un método llamado
\textbf{findOrFail} que nos va a permitir devolver un 404 en caso un usuario
esté intentando hacer el procedimiento anterior mostrado que no es válido.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/085_404_fidOrFail.png}
\end{figure}


%% Clase 18
\section{Validaciones}%
Es muy importante validar siempre la información que los usuarios ingresan en
el sistema. En la mayoría de los casos tendrás usuarios bien intencionados que
sólo busquen hacer uso del sistema, pero puede ocurrir que haya algún atacante
que quiera obtener información que no le pertenece.\\

Cuando por ejemplo se hace submit a un form vacío, no vamos a querer que el
usuario final vea los errores como son lanzados sino manejarlos de alguna
manera, así que los validamos con ayuda de Laravel. Se considerará vació cuando
sea null, no se haya enviado contenido en el formulario, cadena de solo
espacios, si es un arreglo o un objeto Countable o si no hay archivo en el
path cuando se quiere subir archivos.\\

Si en el formulario damos clic en Submit sin escribir nada en el campo,
entonces obtendremos un error.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/086_add_report_null.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/087_add_report_null_error.png}
\end{figure}

Vamos a usar validaciones, para esto podemos ver la
\href{https://laravel.com/docs/6.x/validation#rule-required}{documentación} de
Laravel.\\

Entonces modificamos nuestro controller para poder agregar la validación.\\

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          $validData = $request->validate([
              'title' => 'required'
          ]);

          $report = new ExpenseReport();
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Display the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function show($id)
      {
          //
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.edit', [
              'report' => $report
          ]);
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->delete();

          return redirect('/expense_reports');
      }

      public function confirmDelete($id) {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.confirmDelete', [
              'report' => $report
          ]);
      }
  }
\end{minted}

Ahora si realizamos el mismo procedimiento entonces simplemente volverá cargar
la página. Esto está bien pero también queremos que se informe al usuario el
porqué simplemente está recargando la misma página.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/088_validate_without_message.png}
\end{figure}

Laravel incluye todos los errores de validación que podamos encontrar dentro de
un objeto especial llamado errors el cual podemos usar en nuestro template.\\

\textbf{resources/views/expenseReport/create.blade.php}
\begin{minted}{php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>New Report</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-secondary" href="/expense_reports">Back</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              @if($errors->any())
                  <div class="alert alert-danger">
                      Error
                  </div>
              @endif
              <form action="/expense_reports" method="post">
                  @csrf
                  <div class="form-group">
                      <label for="title">Title:</label>
                      <input type="text" class="form-control" name="title" id="title" placeholder="Type a title">
                  </div>
                  <button class="btn btn-primary" type="submit">Submit</button>
              </form>
          </div>
      </div>
  @endsection
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/089_validate_div_error.png}
\end{figure}

Ha sido un gran avance en nuestro proyecto, pero aún falta que nos indique el
tipo de error.\\

Entonces vamos a trabajar con el objeto \textbf{\$errors} en nuestra vista.\\

\textbf{resources/views/expenseReport/create.blade.php}
\begin{minted}{php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>New Report</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-secondary" href="/expense_reports">Back</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              @if($errors->any())
                  <div class="alert alert-danger">
                      <ul>
                          @foreach ($errors->all() as $error)
                              <li>{{ $error }}</li>
                          @endforeach
                      </ul>
                  </div>
              @endif
              <form action="/expense_reports" method="post">
                  @csrf
                  <div class="form-group">
                      <label for="title">Title:</label>
                      <input type="text" class="form-control" name="title" id="title" placeholder="Type a title">
                  </div>
                  <button class="btn btn-primary" type="submit">Submit</button>
              </form>
          </div>
      </div>
  @endsection
\end{minted}

Luego si queremos realizar el mismo procedimiento, entonces esta vez nos
devolverá el error con el tipo.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/090_error_type.png}
\end{figure}


\begin{itemize}
  \item Se utiliza la línea vertical | para agregar más validaciones.
  \item Si un usuario se equivoca al llenar los campos de formulario y al
    intentarlo de nuevo debe ingresarlos todos otra vez, eso significará una
    mala experiencia de usuario y creará frustración. Por esto mismo se deben
    poner de nuevo los valores y para esto Laravel nos ofrece un auxiliar
    especial llamado old que podemos usar en el valor del campo.
\end{itemize}

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          $validData = $request->validate([
              'title' => 'required|min:3'
          ]);

          $report = new ExpenseReport();
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Display the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function show($id)
      {
          //
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.edit', [
              'report' => $report
          ]);
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->delete();

          return redirect('/expense_reports');
      }

      public function confirmDelete($id) {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.confirmDelete', [
              'report' => $report
          ]);
      }
  }
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/091_submit_a.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/092_min3_error.png}
\end{figure}

Como vimos cuando se refresca la página después de validar un error se pierde
toda la información almacenanda en los campos de los formularios, esto puede
ser una mala experiencia de uso para un usuario, más si se tratan de muchos
campos que eventualmente éste tendría que llenar de nuevo. En este caso Laravel
nos ofrece un auxiliar especial que se llama \textbf{old} que se agrega en el
atributo \textbf{value} del input.\\

\textbf{resources/views/expenseReport/create.blade.php}
\begin{minted}{php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>New Report</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-secondary" href="/expense_reports">Back</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              @if($errors->any())
                  <div class="alert alert-danger">
                      <ul>
                          @foreach ($errors->all() as $error)
                              <li>{{ $error }}</li>
                          @endforeach
                      </ul>
                  </div>
              @endif
              <form action="/expense_reports" method="post">
                  @csrf
                  <div class="form-group">
                      <label for="title">Title:</label>
                      <input type="text" class="form-control" name="title" id="title"
                            placeholder="Type a title" value="{{ old('title') }}">
                  </div>
                  <button class="btn btn-primary" type="submit">Submit</button>
              </form>
          </div>
      </div>
  @endsection
\end{minted}

Enviamos nuevamente una sola letra, en este caso b.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/093_submit_b.png}
\end{figure}

Nos devuelve un error después de refrescarse la página, pero como se observa en
el campo del formulario aún se encuentra la información almacenada antes de que
se refresque. Entonces cuando tengas varios campos, es una buena idea agregar
este helper para almacenar esa información y brindarle una mejor experiencia de
uso al usuario.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/094_min3_error_old.png}
\end{figure}


%% Clase 19
\section{Creamos la vista de reportes}%
En estos momentos ya hemos trabajado bastante con nuestros reportes, aunque
estos reportes son inútiles porque no se están almacenando la información de
los gastos. Vamos a continuar trabajando en el proyecto, para terminar la
funcionalidad que requieren, pero antes de eso vamos a preparar una vista
especial en la cual vamos a ir viendo todos los gastos que van a tener cada uno
de nuestros reportes de gastos.

\begin{itemize}
  \item El método show despliega la información específica para un recurso
    dado.
  \item Existe una técnica en Laravel llamada model binding que antes de llegar
    a la acción realiza el findOrFail y nos envía el objeto que se requiere.
\end{itemize}

Entonces vamos a trabajar en el método \textbf{show} que es el método que aún
no definimos. Para esto primero cambiaremos nuestra vista \textbf{index} para
que nuestros reportes sean ahora un enlace.\\

\textbf{resources/views/expenseReport/index.blade.php}
\begin{minted}{php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>Reports</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-primary" href="/expense_reports/create">Create a new report</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <table class="table">
                  @foreach ($expenseReports as $expenseReport)
                      <tr>
                          <td><a href="/expense_reports/{{$expenseReport->id}}">{{ $expenseReport->title }}</a></td>
                          <td><a href="/expense_reports/{{$expenseReport->id}}/edit">Edit</a></td>
                          <td><a href="/expense_reports/{{$expenseReport->id}}/confirmDelete">Delete</a></td>
                      </tr>
                  @endforeach
              </table>
          </div>
      </div>
  @endsection
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/095_reports_as_links.png}
\end{figure}

Como aún no hemos creado la vista que se mostrará para este enlace, entonces se
mostrará una página en blanco.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/096_blank_page.png}
\end{figure}

Ahora definimos el método \textbf{show} dentro de nuestro controller.\\

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          $validData = $request->validate([
              'title' => 'required|min:3'
          ]);

          $report = new ExpenseReport();
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Display the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function show($id)
      {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.show', [
            'report' => $report
          ]);
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.edit', [
              'report' => $report
          ]);
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->delete();

          return redirect('/expense_reports');
      }

      public function confirmDelete($id) {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.confirmDelete', [
              'report' => $report
          ]);
      }
  }
\end{minted}

Ahora si refrescamos nuestra página entonces ya obtendremos la vista.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/097_expense_report_id.png}
\end{figure}

Ahora en el método \textbf{show} vamos a utilizar una técnica que se llama
\textbf{model binding} en la que Laravel antes de llegar a nuestra acción, hará
el findOrFail y nos va a enviar ya el objeto que se requiere.\\

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          $validData = $request->validate([
              'title' => 'required|min:3'
          ]);

          $report = new ExpenseReport();
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Display the specified resource.
      *
      * @param ExpenseReport $expenseReport
      * @return \Illuminate\Http\Response
      */
      public function show(ExpenseReport $expenseReport)
      {
          return view('expenseReport.show', [
            'report' => $expenseReport
          ]);
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.edit', [
              'report' => $report
          ]);
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->delete();

          return redirect('/expense_reports');
      }

      public function confirmDelete($id) {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.confirmDelete', [
              'report' => $report
          ]);
      }
  }
\end{minted}

Esta parte la trabajamos usando \textbf{PHPStorm} y lo bueno de usar este IDE
es que te ayuda a corregir posibles errores. En nuestro caso se genera un error
de Phpdocs, que podemos solucionarla presionado \textbf{contrl} +
\textbf{Enter}.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/098_update_phpdoc.png}
\end{figure}


\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/099_expense_reports.png}
\end{figure}

Una vez realizado esto entonces podremos tener la misma vista de reportes que
se ha programado para mostrarse en el método \textbf{show} solo que ahora sin
tener que indicar el método findOrFail.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/099_expense_reports.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/100_expense_report_id.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/101_expense_report_id_error.png}
\end{figure}


%% Clase 20
\section{Relaciones con eloquent}%
\begin{itemize}
  \item Si estamos hablando de un blogpost, es posible que éste esté
    relacionado con múltiples comentarios y a su vez con un solo creador.
    Existen muchas maneras para relacionar bases de datos y esto nos ayudará a
    tener una integridad y una referencia hacia lo que necesitamos.
  \item -m o –migration son exactamente lo mismo y se pueden usar
    indistintamente.
  \item Haremos una relación de muchos a uno, es decir que un reporte puede
    tener muchos detalles.
  \item PHP en sus últimas versiones nos ofrece que todas las clases contienen
    la propiedad estática que es el nombre de la clase y la regresa
    directamente.
\end{itemize}

Vamos a la terminal y escribimos lo siguiente:

\begin{minted}{bash}
  php artisan make:model --help
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/102_make_model_migration.png}
\end{figure}

Como vemos, existe la posibilidad de que creemos la migración y después el
modelo. Pero también existe la posibilidad de que usemos la opción \textbf{-m}
que nos creará automáticamente la migración al crear el modelo. Vamos a
probarlo.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/103_expense_model_m.png}
\end{figure}

Si te das cuenta Laravel ya save que se va a crear una tabla y el nombre está
en el plural del de nuestro modelo.\\

Si nos vamos al código observamos que ya se ha creado nuestro modelo y nuestra
migración. Ahora vamos a modificar la migración para indicarle los campos que
tendrá nuestra tabla.\\

\textbf{database/migrations/2019\_11\_26\_105352\_create\_expenses\_table.php}
\begin{minted}{php}
  <?php

  use Illuminate\Database\Migrations\Migration;
  use Illuminate\Database\Schema\Blueprint;
  use Illuminate\Support\Facades\Schema;

  class CreateExpensesTable extends Migration
  {
      /**
      * Run the migrations.
      *
      * @return void
      */
      public function up()
      {
          Schema::create('expenses', function (Blueprint $table) {
              $table->bigIncrements('id');
              $table->unsignedInteger('expense_report_id');
              $table->text('description');
              $table->decimal('amount');
              $table->timestamps();
          });
      }

      /**
      * Reverse the migrations.
      *
      * @return void
      */
      public function down()
      {
          Schema::dropIfExists('expenses');
      }
  }
\end{minted}

Después de esto realizamos la migración:\\

\begin{minted}{bash}
  php migrate
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/104_artisan_migrate.png}
\end{figure}

Con esto se ha creado nuestra tabla \textbf{expenses} con todos los campos que
hemos adicionado. Podemos ver la tabla en nuestro cliente de Base de Datos.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/105_tabla_creada.png}
\end{figure}

Ahora lo que sigue es relacionar las tablas \textbf{expenses} y
\textbf{expense\_reports}. La relación entre expense_report y expenses es de
uno a muchos. Esto se puede indicar agregando funciones dentro de los modelos.\\

\textbf{app/ExpenseReport.php}
\begin{minted}{php}
  <?php

  namespace App;

  use Illuminate\Database\Eloquent\Model;

  class ExpenseReport extends Model
  {
      public function expenses() {
          return $this->hasMany(Expense::class);
      }
  }
\end{minted}

Usamos el método \textbf{hasMany} que indica que un objeto de esta clase puede
estar relacionado a varios obtejos de la clase Expense. Como argumento de la
función \textbf{hasMany} debe ir como un string entre comillas el nombre de la
clase, pero Laravel nos permite ingresar de esta manera lo que evita que
cometamos errores al ingresar el nombre por ejemplo.

\textbf{app/Expense.php}
\begin{minted}{php}
  <?php

  namespace App;

  use Illuminate\Database\Eloquent\Model;

  class Expense extends Model
  {
      public function expenseReport() {
          return $this->belongsTo(ExpenseReport::class);
      }
  }
\end{minted}

Por otro lado en la clase \textbf{Expense} también agregaos una función llamada
\textbf{expenseReport} que retorna el resultado del método \textbf{belongsTo}
para indicar que pertenece a la clase ExpenseReport.\\

Vamos a la terminal para hacer algunas pruebas y ver como está funcionando
esta sección.\\

\begin{minted}{bash}
  php artisan tinker
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/106_tinker.png}
\end{figure}

Como ahora podemos usar \textbf{expenses} como atributo que nos devolverá todos
los gastos considerados es esa tabla y que corresponde a la entidad
expenseReports.\\

El atributo \textbf{expenses} nosotros lo declaramos como un método, pero
Laravel procesa esto y cuando lo llamamos sin los paréntesis como atributo de
la clase ExpenseReport entonces contendrá la información procesada.\\

Ahora vamos a nuestro cliente de Base de Datos e ingresamos manualmente
infomación en la tabla \textbf{expenses} e indicamos el id de una de los
expenseReports en el campo \textbf{expense\_report\_id}.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/107_expenses_insert_manual.png}
\end{figure}

Luego vamos a tinker nuevamente y probamos listar los \textbf{expenses}
nuevamente.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/108_expenses_ok.png}
\end{figure}

También a partir de la entidad \textbf{expenses} podemos ver el
\textbf{expenseReport} relacionado.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/109_expenses_ok.png}
\end{figure}

Por defecto Laravel interpreta que expense\_repor\_id es el atributo que
relaciona ambas tablas, esto sucede así porque usamos en el nombre al final un
\_id. Podemos seguir trabajando de esta manera o podemos indicarle a Laravel si
lo hacemos con otra convención.\\




%% Clase 21
\section{Trabajando con relaciones}%
Ahora que ya tenemos creada nuestra relación y hemos hecho algunas pruebas
usando \textbf{tinker} es el momento de que comenzemos a utilizarla dentro de
nuestro proyecto.\\

Vamos a la vista \textbf{show} para que muestre el contenido de la tabla
\textbf{expenses}.

\textbf{resources/views/expenseReport/show.blade.php}
\begin{minted}{html+php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>Report: {{ $report->title }}</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-secondary" href="/expense_reports">Back</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <h3>Details</h3>
              <table class="table">
                  @foreach ($report->expenses as $expense)
                      <tr>
                          <td>{{ $expense->description }}</td>
                          <td>{{ $expense->created_at }}</td>
                          <td>{{ $expense->amount }}</td>
                      </tr>
                  @endforeach
              </table>
          </div>
      </div>
  @endsection
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/110_report_cena2.png}
\end{figure}

Ahora vamos a crear un crear un formulario para poder agregar nuevos reportes
de gastos. Para eso vamos a crear un nuevo controlador tipo recurso.\\

\begin{minted}{bash}
  php artisan make:controller --resource ExpenseController
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/111_make_controller_expense.png}
\end{figure}

Luego vamos a crear una nueva columna con un botón que nos enviará al registro
de los \textbf{expenses}. Para eso modificamos nuevamente nuestra vista show.\\


\textbf{resources/views/expenseReport/show.blade.php}
\begin{minted}{php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>Report: {{ $report->title }}</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-secondary" href="/expense_reports">Back</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <h3>Details</h3>
              <table class="table">
                  @foreach ($report->expenses as $expense)
                      <tr>
                          <td>{{ $expense->description }}</td>
                          <td>{{ $expense->created_at }}</td>
                          <td>{{ $expense->amount }}</td>
                      </tr>
                  @endforeach
              </table>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-primary"
                href="/expense_reports/{{ $report->id }}/expenses/create">New expense</a>
          </div>
      </div>
  @endsection
\end{minted}

Si probamos en el navegador nos retornará un error 404 ya que este url aún no
ha sido rooteado.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/112_new_expense.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/113_404_new_expense.png}
\end{figure}

Ahora vamos a modificar nuestro fichero \textbf{web.php} en \textbf{routes}
para incluir estas rutas.

\textbf{routes/web.php b/routes/web.php}
\begin{minted}{php}
  <?php

  /*
  |--------------------------------------------------------------------------
  | Web Routes
  |--------------------------------------------------------------------------
  |
  | Here is where you can register web routes for your application. These
  | routes are loaded by the RouteServiceProvider within a group which
  | contains the "web" middleware group. Now create something great!
  |
  */

  Route::get('/', 'HomeController@index');
  Route::get('/dashboard', 'DashboardController@index');
  Route::resource('/expense_reports', 'ExpenseReportController');
  Route::get('/expense_reports/{id}/confirmDelete', 'ExpenseReportController@confirmDelete');
  Route::get('/expense_reports/{expense_report}/expenses/create', 'ExpenseController@create');
  Route::post('/expense_reports/{expense_report}/expenses', 'ExpenseController@store');
\end{minted}

Luego de esto si refrescamos el navegador veremos una página en blanco ya que
todavía no hemos programado su comportamiento.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/114_blank_page.png}
\end{figure}

Para empezar creamos una vista para el formulario.

\textbf{resources/views/expense/create.blade.php}
\begin{minted}{html+php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>New Expense</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-secondary" href="/expense_reports/{{ $report->id }}">Back</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              @if($errors->any())
                  <div class="alert alert-danger">
                      <ul>
                          @foreach ($errors->all() as $error)
                              <li>{{ $error }}</li>
                          @endforeach
                      </ul>
                  </div>
              @endif
              <form action="/expense_reports/{{ $report->id }}/expenses" method="post">
                  @csrf
                  <div class="form-group">
                      <label for="description">Description:</label>
                      <input type="text" class="form-control" name="description" id="description"
                            placeholder="Type a description" value="{{ old('title') }}">
                  </div>
                  <div class="form-group">
                      <label for="amount">Amount:</label>
                      <input type="text" class="form-control" name="amount" id="amount"
                            placeholder="Type a amount" value="{{ old('amount') }}">
                  </div>
                  <button class="btn btn-primary" type="submit">Submit</button>
              </form>
          </div>
      </div>
  @endsection
\end{minted}

Luego vamos a modificar el controlador \textbf{ExpenseController} en sus
métodos \textbf{create} para retornar la vista con el formulario y
\textbf{store} para comprobar usando dd su acceso.

\textbf{app/Http/Controllers/ExpenseController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use Illuminate\Http\Request;
  use App\ExpenseReport;

  class ExpenseController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          //
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create(ExpenseReport $expenseReport)
      {
          return view('expense.create', [
              'report' => $expenseReport
          ]);
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          dd($request->all());
      }

      /**
      * Display the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function show($id)
      {
          //
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          //
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          //
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          //
      }
  }
\end{minted}

Ahora si refrescamos la página nuevamente, esta vez visualizaremos el
formulario. Vamos a llenar los campos y damos clic en Submit para enviar.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/115_new_expense.png}
\end{figure}

Después de enviar, nos aparece otra página en la que se visualiza un arreglo
con el tocken de csrf, descripcion y la cantidad. Esto se despliega por el
método \textbf{dd} que usamos dentro de \textbf{store} del ExpenseController.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/116_dd_store.png}
\end{figure}

Ahora vamos a completar con el almacenamiento de los campos, para esto
modificaremos el controller en su método store.

\textbf{app/Http/Controllers/ExpenseController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use Illuminate\Http\Request;
  use App\ExpenseReport;
  use App\Expense;

  class ExpenseController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          //
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create(ExpenseReport $expenseReport)
      {
          return view('expense.create', [
              'report' => $expenseReport
          ]);
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request, ExpenseReport $expenseReport)
      {
          $expense = new Expense();
          $expense->description = $request->get('description');
          $expense->amount = $request->get('amount');
          $expense->expense_report_id = $expenseReport->id;
          $expense->save();

          return redirect('/expense_reports/' . $expenseReport->id);
      }

      /**
      * Display the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function show($id)
      {
          //
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          //
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          //
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          //
      }
  }
\end{minted}

Luego de esto mandamos a refrescar la página aceptando el reenvío del
formulario.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/117_refrescar.png}
\end{figure}

Como vemos nos redirecciona donde se muestra la información de los reportes y
se verifica el registro.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/118_store_ok.png}
\end{figure}

Con esto ya se ha terminado el registro, lo que nos falta es validar los datos
ingresados.



%% Clase 22
\section{Acción para enviar un mail}%
Siguiendo el proyecto que se viene trabajando en el curso, y también en muchos
otros proyectos que realices puedes querer implementar un sistema de envío de
mails por diferentes motivos, sea avisar a alguien de tu empresa que deba salir
de viaje sobre algo que esté sucediendo o avisar a tus clientes de alguna
acción que se esté llevando a cabo en tu sistema o haya sido completada.\\

Vamos a crear un nuevo botón para enviar nuestros reportes por email.

\textbf{resources/views/expenseReport/show.blade.php}
\begin{minted}{php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>Report: {{ $report->title }}</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-secondary" href="/expense_reports">Back</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-primary"
                href="/expense_reports/{{ $report->id }}/confirmSendMail">Send email</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <h3>Details</h3>
              <table class="table">
                  @foreach ($report->expenses as $expense)
                      <tr>
                          <td>{{ $expense->description }}</td>
                          <td>{{ $expense->created_at }}</td>
                          <td>{{ $expense->amount }}</td>
                      </tr>
                  @endforeach
              </table>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-primary"
                href="/expense_reports/{{ $report->id }}/expenses/create">New expense</a>
          </div>
      </div>
  @endsection
\end{minted}

Esto se verá reflejado de la siguiente manera en nuestro navegador.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/119_send_email.png}
\end{figure}

Si damos clic en el botón, como la ruta aún no está agregada a nuestro archivo
de rutas entonces devolverá un error 404.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/120_404.png}
\end{figure}

Entonces agregaremos la ruta a nuestro archivo de rutas en \textbf{web.php}.

\textbf{routes/web.php}
\begin{minted}{php}
  <?php

  /*
  |--------------------------------------------------------------------------
  | Web Routes
  |--------------------------------------------------------------------------
  |
  | Here is where you can register web routes for your application. These
  | routes are loaded by the RouteServiceProvider within a group which
  | contains the "web" middleware group. Now create something great!
  |
  */

  Route::get('/', 'HomeController@index');
  Route::get('/dashboard', 'DashboardController@index');
  Route::resource('/expense_reports', 'ExpenseReportController');
  Route::get('/expense_reports/{id}/confirmDelete', 'ExpenseReportController@confirmDelete');
  Route::get('/expense_reports/{id}/confirmSendMail', 'ExpenseReportController@confirmSendMail');

  Route::get('/expense_reports/{expense_report}/expenses/create', 'ExpenseController@create');
  Route::post('/expense_reports/{expense_report}/expenses', 'ExpenseController@store');
\end{minted}

Creamos el método \textbf{confirmSendMail} en nuestro controlador.

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          $validData = $request->validate([
              'title' => 'required|min:3'
          ]);

          $report = new ExpenseReport();
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Display the specified resource.
      *
      * @param ExpenseReport $expenseReport
      * @return \Illuminate\Http\Response
      */
      public function show(ExpenseReport $expenseReport)
      {
          return view('expenseReport.show', [
            'report' => $expenseReport
          ]);
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.edit', [
              'report' => $report
          ]);
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->delete();

          return redirect('/expense_reports');
      }

      public function confirmDelete($id) {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.confirmDelete', [
              'report' => $report
          ]);
      }

      public function confirmSendMail($id) {

      }
  }
\end{minted}

Ahora si recargamos, nuestro navegador entonces ya no nos saldrá el error 404,
pero como aún no hemos trabajado en el método confirmSendMail entonces la
página devuelta estará en blanco.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/121_blank_page_ok.png}
\end{figure}

Entonces procedemos a crear la nueva vista y a retornarla desde del método en
nuestro controlador.

\textbf{resources/views/expenseReport/confirmSendMail.blade.php}
\begin{minted}{html+php}
  @extends('layouts.base')

  @section('content')
      <div class="row">
          <div class="col">
              <h1>Send Report</h1>
          </div>
      </div>
      <div class="row">
          <div class="col">
              <a class="btn btn-secondary" href="/expense_reports">Back</a>
          </div>
      </div>
      <div class="row">
          <div class="col">
              @if($errors->any())
                  <div class="alert alert-danger">
                      <ul>
                          @foreach ($errors->all() as $error)
                              <li>{{ $error }}</li>
                          @endforeach
                      </ul>
                  </div>
              @endif
              <form action="/expense_reports/{{ $report->id }}/sendMail" method="post">
                  @csrf
                  <div class="form-group">
                      <label for="email">Email:</label>
                      <input type="email" class="form-control" name="email" id="email"
                            placeholder="Type a email" value="{{ old('email') }}">
                  </div>
                  <button class="btn btn-primary" type="submit">Send Mail</button>
              </form>
          </div>
      </div>
  @endsection
\end{minted}

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          $validData = $request->validate([
              'title' => 'required|min:3'
          ]);

          $report = new ExpenseReport();
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Display the specified resource.
      *
      * @param ExpenseReport $expenseReport
      * @return \Illuminate\Http\Response
      */
      public function show(ExpenseReport $expenseReport)
      {
          return view('expenseReport.show', [
            'report' => $expenseReport
          ]);
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.edit', [
              'report' => $report
          ]);
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->delete();

          return redirect('/expense_reports');
      }

      public function confirmDelete($id) {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.confirmDelete', [
              'report' => $report
          ]);
      }

      public function confirmSendMail($id) {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.confirmSendMail', [
              'report' => $report
          ]);
      }
  }
\end{minted}

Si recargamos nuestro navegador esta vez sí veremos el formulario creado.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/122_send_mail_form.png}
\end{figure}

El url del botón \textbf{Send Mail} aún no lo tenemos añadido en nuestro
fichero de rutas y falta también vincularla con una acción para que tenga
funcionalidad. Entonces añadimos la nueva ruta. Recuerda que el envío se hace
con método post.\\

\textbf{routes/web.php}
\begin{minted}{php}
  <?php

  /*
  |--------------------------------------------------------------------------
  | Web Routes
  |--------------------------------------------------------------------------
  |
  | Here is where you can register web routes for your application. These
  | routes are loaded by the RouteServiceProvider within a group which
  | contains the "web" middleware group. Now create something great!
  |
  */

  Route::get('/', 'HomeController@index');
  Route::get('/dashboard', 'DashboardController@index');
  Route::resource('/expense_reports', 'ExpenseReportController');
  Route::get('/expense_reports/{id}/confirmDelete', 'ExpenseReportController@confirmDelete');
  Route::get('/expense_reports/{id}/confirmSendMail', 'ExpenseReportController@confirmSendMail');
  Route::post('/expense_reports/{id}/sendMail', 'ExpenseReportController@sendMail');

  Route::get('/expense_reports/{expense_report}/expenses/create', 'ExpenseController@create');
  Route::post('/expense_reports/{expense_report}/expenses', 'ExpenseController@store');
\end{minted}

Por ahora simplemente vamos a devolver el reporte tal cual.

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use Illuminate\Http\Request;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          $validData = $request->validate([
              'title' => 'required|min:3'
          ]);

          $report = new ExpenseReport();
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Display the specified resource.
      *
      * @param ExpenseReport $expenseReport
      * @return \Illuminate\Http\Response
      */
      public function show(ExpenseReport $expenseReport)
      {
          return view('expenseReport.show', [
            'report' => $expenseReport
          ]);
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.edit', [
              'report' => $report
          ]);
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->delete();

          return redirect('/expense_reports');
      }

      public function confirmDelete($id) {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.confirmDelete', [
              'report' => $report
          ]);
      }

      public function confirmSendMail($id) {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.confirmSendMail', [
              'report' => $report
          ]);
      }

      public function sendMail($id) {
          $report = ExpenseReport::find($id);
          return $report;
      }
  }
\end{minted}

Si recargamos la página vamos a observar que nos devuelve el objeto report en
formato json.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/123_report_json.png}
\end{figure}


%% Clase 23
\section{Enviando emails}%
Para enviar correos electrónicos necesitamos usar algún servicio especializado
en lugar de cuentas propias tipo gmail porque estas últimas tienden a
bloquearse al detectar mucha actividad de envíos. mailtrap.io ofrece un
servicio especial para probar cómo funciona el envío de correos durante el
desarrollo de una aplicación.\\

\begin{itemize}
  \item Dentro de tu cuenta de mailtrap tendrás tus diferentes bandejas de
    entrada y al entrar a ellas encontrarás las credenciales necesarias para
    configurar la aplicación. Lo más común es usar credenciales SMTP.
  \item En nuestro archivo .env encontraremos cómo configurar el envío de
    email. Necesitaremos el username y el password.
  \item La configuración real se hace siempre dentro de la carpeta config en el
    archivo mail.php
  \item PHP artisan nos provee el comando make:mail que se usa para crear una
    nueva clase de email. En Laravel los correos electrónicos son objetos que
    podemos trabajar con ciertas características e incluso darles un template
    para que sean rendereados.
  \item Laravel nos ofrece un facade llamado Mail que nos ayuda a hacer el
    envío.
\end{itemize}

Entonces usaremos el servicio de mailtrap, para esto nos vamos al siguiente
\href{https://mailtrap.io/}{enlace} y nos creamos una cuenta. Luego de tener la
cuenta podemos dar clic en nuestro usuario para que nos redireccione a nuestro
inbox.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/124_mailtrapio_web.png}
\end{figure}

Una vez en nuestro inbox le damos clic en Demo inbox para que nos muestre las
credenciales.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/125_inbox.png}
\end{figure}

Estas credenciales son las que usaremos para configurar en Laravel y podamos
enviar correos.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/126_credentials.png}
\end{figure}

Agregamos username y password en nuestro archivo \textbf{.env}. Hay que tener
en cuenta que en realidad donde se configura nuestro servicio es en la ruta
\textbf{config/mail.php} que invoca el valor de estas variables de entorno.\\

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/127_env_credentials.png}
\end{figure}

Laravel con artisan nos permite crear clases de tipo email.

\begin{minted}{bash}
  php artisan make:mail --help
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/128_make_mail_help.png}
\end{figure}

Entonces usando esta funcionalidad, vamos a crear nuestra clase de tipo email
llamada \textbf{SummaryReport}.

\begin{minted}{bash}
  php artisan make:mail SummaryReport
\end{minted}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/129_make_mail_created.png}
\end{figure}

Luego de esto se ha creado una nueva carpeta en \textbf{app} llamada
\textbf{mail} y dentro tendremos a la clase \textbf{SummaryReport} que hemos
creado. La modificamos para poder hacer el envío del correo.\\

\textbf{app/Mail/SummaryReport.php}
\begin{minted}{php}
  <?php

  namespace App\Mail;

  use App\ExpenseReport;
  use Illuminate\Bus\Queueable;
  use Illuminate\Contracts\Queue\ShouldQueue;
  use Illuminate\Mail\Mailable;
  use Illuminate\Queue\SerializesModels;

  class SummaryReport extends Mailable
  {
      use Queueable, SerializesModels;
      private $expenseReport;

      /**
      * Create a new message instance.
      *
      * @return void
      */
      public function __construct(ExpenseReport $expenseReport)
      {
          $this->expenseReport = $expenseReport;
      }

      /**
      * Build the message.
      *
      * @return $this
      */
      public function build()
      {
          return $this->view('mail.expenseReport', [
              'report' => $this->expenseReport
          ]);
      }
  }
\end{minted}

El objeto creado a partir de esta clase puede enviarse por correo y además
tiene soporte para usar el formato que le proporciona blade. Entonces crearemos
una nueva carpeta llamada mail dentro de views y tendrá una vista que de
formato a nuestro correo.\\

\textbf{resources/views/mail/expenseReport.blade.php}
\begin{minted}{html+php}
  <div class="row">
      <div class="col">
          <h1>Expense Report {{ $report->id }}: {{ $report->title }}</h1>
      </div>
  </div>
  <div class="row">
      <div class="col">
          <h2>expenses</h2>
          <table class="table">
              @foreach ($report->expenses as $expense)
                  <tr>
                      <td>{{ $expense->description }}</td>
                      <td>{{ $expense->created_at }}</td>
                      <td>{{ $expense->amount }}</td>
                  </tr>
              @endforeach
          </table>
      </div>
  </div>
\end{minted}

Ahora ya tenemos tanto la clase para enviar el correo como la vista que le dará
formato, solo nos falta usarlas para poder hacer el envío. Esto se hara desde
el controller.

\textbf{app/Http/Controllers/ExpenseReportController.php}
\begin{minted}{php}
  <?php

  namespace App\Http\Controllers;

  use App\ExpenseReport;
  use App\Mail\SummaryReport;
  use Illuminate\Http\Request;
  use Illuminate\Support\Facades\Mail;

  class ExpenseReportController extends Controller
  {
      /**
      * Display a listing of the resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function index()
      {
          return view('expenseReport.index', [
              'expenseReports' => ExpenseReport::all()
          ]);
      }

      /**
      * Show the form for creating a new resource.
      *
      * @return \Illuminate\Http\Response
      */
      public function create()
      {
          return view('expenseReport.create');
      }

      /**
      * Store a newly created resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @return \Illuminate\Http\Response
      */
      public function store(Request $request)
      {
          $validData = $request->validate([
              'title' => 'required|min:3'
          ]);

          $report = new ExpenseReport();
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Display the specified resource.
      *
      * @param ExpenseReport $expenseReport
      * @return \Illuminate\Http\Response
      */
      public function show(ExpenseReport $expenseReport)
      {
          return view('expenseReport.show', [
            'report' => $expenseReport
          ]);
      }

      /**
      * Show the form for editing the specified resource.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function edit($id)
      {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.edit', [
              'report' => $report
          ]);
      }

      /**
      * Update the specified resource in storage.
      *
      * @param  \Illuminate\Http\Request  $request
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function update(Request $request, $id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->title = $request->get('title');
          $report->save();

          return redirect('/expense_reports');
      }

      /**
      * Remove the specified resource from storage.
      *
      * @param  int  $id
      * @return \Illuminate\Http\Response
      */
      public function destroy($id)
      {
          $report = ExpenseReport::findOrFail($id);
          $report->delete();

          return redirect('/expense_reports');
      }

      public function confirmDelete($id) {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.confirmDelete', [
              'report' => $report
          ]);
      }

      public function confirmSendMail($id) {
          $report = ExpenseReport::findOrFail($id);
          return view('expenseReport.confirmSendMail', [
              'report' => $report
          ]);
      }

      public function sendMail(Request $request, $id) {
          $report = ExpenseReport::find($id);
          Mail::to($request->get('email'))->send(new SummaryReport($report));

          return redirect('/expense_reports/' . $id);
      }
  }
\end{minted}

Ahora vamos a probar hacer el envío del correo.

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/130_send_mail.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/131_send_mail.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/132_send_mail.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/133_send_mail.png}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[scale=0.5]{./Pictures/134_send_mail_ok.png}
\end{figure}


%% Clase 24
\section{Login}%
Para evitar que todo el contenido de la aplicación sea público, es necesario
utilizar un sistema de autentificación de los usuarios. Para esto tenemos
muchos mecanismos en Laravel supremamente sencillos de utilizar.\\

\begin{itemize}
  \item PHP artisan nos ofrece make:auth que es una estructura para hacer un
    login y registro básicos con las vistas y las rutas.
  \item Al agregar la línea \$this$->$middleware('auth'); tenemos el controlador
    protegido, lo que quiere decir que no puede ser accedido si el usuario no
    está logueado.
\end{itemize}

%% Clase 25
\section{Cierre}%














\end{document}

